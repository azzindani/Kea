# Kernel Behavioral Configuration
# All numeric thresholds, retry policy, and defaults used by the orchestrator kernel.
# Edit here to tune behavior without touching Python source.

execution:
  min_valid_output_length: 5        # Minimum chars for a tool output to count as valid
  error_short_content_max: 200      # Content shorter than this + error term → treat as error
  error_early_position_max: 100     # Error term appearing before this char pos → treat as error
  citation_preview_length: 500      # Max chars kept in tool citation result_preview
  fact_rerank_truncation: 8000      # Max chars of each fact sent to reranker
  report_max_facts: 10              # Max facts listed in final synthesizer report
  report_max_invocations: 25        # Max tool invocations shown in source table
  report_max_sources_fallback: 10   # Fallback source list length when no citations
  max_agentic_tools: 50             # Max tools passed to agentic workflow context

retry:
  base_retries: 5                   # Default max retries for tool execution
  cpu_scale_min: 3                  # Minimum retries regardless of CPU count
  cpu_scale_max: 8                  # Maximum retries regardless of CPU count
  cpu_scale_divisor: 2              # Retries = clamp(cpu_count // divisor, min, max)

defaults:
  max_revisions: 2                  # Max Generator revision loops before forced finalize
  max_parallel_fallback: 6          # Parallel workers when complexity info unavailable
  fallback_tool: web_search         # Default tool when no plan is available

llm_callbacks:
  planner_temperature: 0.3          # Temperature for internal LLM callbacks (parameter corrector, spawner)
  planner_max_tokens: 32768         # Max tokens for internal LLM callbacks

# ==============================================================================
# Kernel Cell v1.0 Configuration
# ==============================================================================

kernel_cell:
  # Token Budget Defaults
  budget:
    default_max_tokens: 32768
    simple_query_budget: 5000
    complex_query_budget: 50000
    min_child_budget: 1000
    reserve_for_synthesis: 2000

  # Recursion Limits
  recursion:
    max_depth: 5
    max_children_per_cell: 8
    max_steps_per_cell: 15

  # Quality Gates Per Level
  quality_gates:
    intern:   { min_accuracy: 0.55, min_composite: 0.45, max_retries: 3 }
    staff:    { min_accuracy: 0.65, min_composite: 0.55, max_retries: 2 }
    manager:  { min_accuracy: 0.70, min_composite: 0.60, max_retries: 1 }
    director: { min_accuracy: 0.75, min_composite: 0.65, max_retries: 1 }
    vp:       { min_accuracy: 0.80, min_composite: 0.70, max_retries: 1 }
    ceo:      { min_accuracy: 0.85, min_composite: 0.75, max_retries: 0 }

  # Score Dimension Weights
  scoring:
    accuracy: 0.25
    completeness: 0.18
    relevance: 0.18
    depth: 0.13
    novelty: 0.06
    coherence: 0.10
    actionability: 0.10

  # Aggregation Weights for Hierarchical Roll-up
  aggregation:
    children_weight: 0.50
    review_weight: 0.30
    integration_weight: 0.20

  # Knowledge Retrieval
  knowledge:
    default_skill_limit: 3
    default_rule_limit: 2
    default_procedure_limit: 2

  # Consensus Rounds Per Level
  consensus:
    staff_rounds: 0
    manager_rounds: 1
    director_rounds: 2
    vp_rounds: 2
    ceo_rounds: 3

  # Quality Bar Instructions (injected into every LLM call by inference engine)
  quality_instructions:
    draft: >
      QUALITY: DRAFT — Prioritize speed and coverage over polish.
      Incomplete data is acceptable — flag gaps clearly.
    professional: >
      QUALITY: PROFESSIONAL — Deliver thorough, well-structured, verified output.
      Cross-reference data points. Cite sources.
    executive: >
      QUALITY: EXECUTIVE — Deliver boardroom-ready output: precise language,
      no filler, actionable insights, quantified claims,
      risk-aware recommendations with confidence levels.

  # Maps existing ComplexityTier → ProcessingMode (used by _assess_complexity)
  complexity_mode_mapping:
    trivial: direct
    low: solo
    medium: solo
    high: delegate
    extreme: hierarchy

  # Maps ComplexityTier → starting kernel level (organizational hierarchy entry point)
  # Used by main.py _kernel_level_from_complexity() to decide which org level handles a query
  complexity_level_mapping:
    trivial: staff
    low: senior_staff
    medium: manager
    high: director
    extreme: ceo

  # Depth escalation: when depth >= threshold, promote level to at least min_level
  # Only applies if current level is in escalate_from list
  depth_escalation:
    threshold: 4
    min_level: director
    escalate_from: [staff, senior_staff, manager]

  # Output formatting (Phase 3)
  output:
    default_format: report
    min_artifacts: 1
    max_artifacts: 10
    formats:
      report:
        min_sections: 2
        required: [overview, conclusion]
      executive_brief:
        max_words: 500
        required: [key_findings, recommendations]
      data_analysis:
        required: [methodology, findings, data_tables]

  # Reranking configuration (Phase 2.5)
  reranking:
    enabled: false              # Set true when reranker model is available
    top_k: 10                   # Keep top-K facts after reranking
    min_facts_for_rerank: 3     # Only rerank if this many facts exist

  # Communication Network (v2.0)
  communication:
    budget_pct: 0.15                    # Fraction of task budget for messaging
    max_messages_per_cell: 20           # Hard cap on messages a cell can send
    clarify_timeout_seconds: 15         # How long to wait for clarification answer
    progress_interval_steps: 3          # Report progress every N execution steps
    channel_costs:                      # Token cost per message by channel
      clarify: 150
      progress: 50
      escalate: 500
      partial: 200
      blocked: 300
      consult: 300
      share: 100
      coordinate: 200
      feedback: 200
      alert: 100

  # Recursive Self-Healing (v2.1 — Claude Code Recursion)
  # Enables detect → diagnose → fix → cascade-check → converge loop
  healing:
    enabled: true
    max_iterations: 3              # Max recursive heal loops per cell
    max_cascade_depth: 3           # Max depth of error causality chain
    budget_fraction: 0.25          # Max fraction of remaining budget for healing
    min_budget_for_heal: 1000      # Don't heal if budget below this
    diminishing_returns_threshold: 0.1  # Stop if <10% improvement per iteration
    max_new_errors_per_iteration: 5     # Abort if fix introduces too many new errors
    # Per-level overrides
    levels:
      intern:       { enabled: false }
      staff:        { max_iterations: 1, max_cascade_depth: 1 }
      senior_staff: { max_iterations: 2, max_cascade_depth: 2 }
      manager:      { max_iterations: 3, max_cascade_depth: 3 }
      director:     { max_iterations: 3, max_cascade_depth: 3 }
      vp:           { max_iterations: 3, max_cascade_depth: 3 }
      ceo:          { max_iterations: 2, max_cascade_depth: 2 }

  # Iterative Delegation Protocol (v2.0, Phase 3)
  delegation:
    max_review_rounds: 2                 # Max revision cycles before accepting
    review_cost_per_subtask: 32768         # Token cost for LLM-based quality review
    conflict_resolution_cost: 32768        # Token cost per conflict resolved
    min_budget_for_review: 2000          # Skip review if budget below this
    # Quality acceptance thresholds by parent level
    quality_thresholds:
      staff: 0.5                         # Staff accepts more readily
      senior_staff: 0.6
      manager: 0.7                       # Managers are pickier
      senior_manager: 0.75
      director: 0.8
      vp: 0.85

# ==============================================================================
# Cognitive Profiles v2.0 — Level-Aware Thinking
#
# Each profile defines HOW a kernel cell thinks at that organizational level.
# These override the hardcoded defaults in cognitive_profiles.py.
#
# Keys:
#   primary_modes      — CognitiveMode values this level spends most time on
#   execution_pct      — Fraction of work done by self (vs. delegated)
#   delegation_pct     — Fraction of work delegated to subordinates
#   review_depth       — How deeply this level reviews work (none|checklist|self_review|detailed|thorough|moderate|light)
#   reasoning_style    — Cognitive approach shaping the LLM prompt
#   time_horizon       — How far ahead this level plans
#   max_reasoning_steps — Budget for the cognitive cycle's execute loop
#   max_tool_calls     — Max tool calls before forced synthesis
#   max_self_monitor_checks — Mid-execution quality checks
#   can_delegate       — Whether this level can delegate to subordinates
#   can_escalate       — Whether this level can escalate to parent
#   can_consult_peers  — Whether this level can consult sibling cells
#
# Reasoning styles: direct_lookup | procedural | deep_analytical |
#                   task_oriented | structured_analysis | cross_functional |
#                   strategic_pattern
# ==============================================================================

cognitive_profiles:

  board:
    primary_modes: [strategize, frame, prioritize]
    execution_pct: 0.05
    delegation_pct: 0.80
    review_depth: light
    reasoning_style: strategic_pattern
    time_horizon: years
    max_reasoning_steps: 4
    max_tool_calls: 0
    max_self_monitor_checks: 1
    can_delegate: true
    can_escalate: false
    can_consult_peers: true

  ceo:
    primary_modes: [frame, decompose, strategize, synthesize]
    execution_pct: 0.10
    delegation_pct: 0.70
    review_depth: moderate
    reasoning_style: cross_functional
    time_horizon: quarters_to_years
    max_reasoning_steps: 6
    max_tool_calls: 1
    max_self_monitor_checks: 2
    can_delegate: true
    can_escalate: true
    can_consult_peers: true

  vp:
    primary_modes: [decompose, prioritize, synthesize, self_assess]
    execution_pct: 0.15
    delegation_pct: 0.55
    review_depth: moderate
    reasoning_style: structured_analysis
    time_horizon: months_to_quarters
    max_reasoning_steps: 8
    max_tool_calls: 2
    max_self_monitor_checks: 3
    can_delegate: true
    can_escalate: true
    can_consult_peers: true

  director:
    primary_modes: [decompose, prioritize, analyze, synthesize]
    execution_pct: 0.20
    delegation_pct: 0.50
    review_depth: thorough
    reasoning_style: structured_analysis
    time_horizon: weeks_to_months
    max_reasoning_steps: 10
    max_tool_calls: 3
    max_self_monitor_checks: 3
    can_delegate: true
    can_escalate: true
    can_consult_peers: true

  manager:
    primary_modes: [decompose, research, analyze, self_assess]
    execution_pct: 0.30
    delegation_pct: 0.40
    review_depth: detailed
    reasoning_style: task_oriented
    time_horizon: days_to_weeks
    max_reasoning_steps: 12
    max_tool_calls: 5
    max_self_monitor_checks: 4
    can_delegate: true
    can_escalate: true
    can_consult_peers: true

  senior_staff:
    primary_modes: [research, analyze, synthesize, create]
    execution_pct: 0.70
    delegation_pct: 0.10
    review_depth: self_review
    reasoning_style: deep_analytical
    time_horizon: hours_to_days
    max_reasoning_steps: 15
    max_tool_calls: 8
    max_self_monitor_checks: 5
    can_delegate: false
    can_escalate: true
    can_consult_peers: true

  staff:
    primary_modes: [research, analyze, create]
    execution_pct: 0.85
    delegation_pct: 0.0
    review_depth: checklist
    reasoning_style: procedural
    time_horizon: minutes_to_hours
    max_reasoning_steps: 10
    max_tool_calls: 5
    max_self_monitor_checks: 2
    can_delegate: false
    can_escalate: true
    can_consult_peers: false

  intern:
    primary_modes: [research, create]
    execution_pct: 0.95
    delegation_pct: 0.0
    review_depth: none
    reasoning_style: direct_lookup
    time_horizon: immediate
    max_reasoning_steps: 5
    max_tool_calls: 3
    max_self_monitor_checks: 1
    can_delegate: false
    can_escalate: true
    can_consult_peers: false

# ==============================================================================
# Convergence Detection (Phase 2.2)
# Stops execution when new steps aren't adding meaningful information.
# ==============================================================================

convergence:
  min_new_info_pct: 0.10           # New step must add >10% new words
  consecutive_stagnant_steps: 2    # Stop after this many stagnant steps
  confidence_threshold_multiplier: 1.1  # Stop if confidence > quality_gate * this

# ==============================================================================
# Organization Structure (Phase 4)
# Defines default departments and role resolution for corporation simulation.
# ==============================================================================

organization:
  default_departments:
    - name: Research
      domain: research
      default_roles: [market_researcher, data_scientist]
    - name: Finance
      domain: finance
      default_roles: [financial_analyst]
    - name: Legal
      domain: legal
      default_roles: [legal_analyst]
    - name: Strategy
      domain: strategy
      default_roles: [strategist]
    - name: Technology
      domain: technology
      default_roles: [data_scientist]
  skip_levels_for_simple: true
  budget_allocation: equal         # equal | weighted | priority

# ==============================================================================
# Kernel Exploration Phase (Step 1 — Pre-Planning Reconnaissance)
# Enables Claude-Code-style exploration before the PLAN phase.
# ==============================================================================

kernel_cell_explore:
  enabled: true
  max_tools_to_scan: 30            # Max tools to consider from registry
  max_knowledge_snippets: 5        # Max knowledge chunks from retriever
  max_prior_findings: 3            # Max Vault cross-session findings
  skip_for_levels: [intern]        # These levels skip exploration
  budget_fraction: 0.05            # Max fraction of budget for exploration

# ==============================================================================
# Kernel Intent Routing (Step 2 — Path A/B/C/D Classification)
# Integrates IntentionRouter into the kernel's PERCEIVE phase.
# ==============================================================================

kernel_cell_routing:
  enabled: true
  use_llm_fallback: true           # Use LLM if heuristics don't match
  default_path: D                  # Default to deep research
  path_overrides:
    A:
      inject_conversation: true    # Inject conversation history
      max_prior_facts: 20          # Max facts from prior sessions
    B:
      verification_mode: true      # Cross-verify claims
      spawn_shadow_cell: true      # Spawn a verification child cell
    C:
      multi_topic: true            # Aggregate across topics
      min_sources: 5               # Minimum source diversity
    D:
      deep_mode: true              # Full deep research

# ==============================================================================
# Kernel DAG Execution (Step 3 — Self-Assembling Workflows)
# Replaces sequential tool calls with parallel, dependency-driven DAG execution.
# ==============================================================================

kernel_cell_dag:
  enabled: true
  min_complexity_for_dag: medium   # trivial/low use sequential fallback
  max_concurrent_default: 4        # Overridden by hardware detection
  enable_microplanner: true        # Reactive mid-execution replanning
  enable_artifact_cache: true      # Cache identical tool call results
  sequential_fallback: true        # Fall back to sequential on DAG failure

# ==============================================================================
# Kernel Keeper Guard (Step 4 — Context Quality in MONITOR Phase)
# Ports the legacy graph's keeper node capabilities into the kernel.
# ==============================================================================

kernel_cell_keeper:
  enabled: true
  rerank_facts: true               # Neural reranking by relevance
  rerank_top_k: 10                 # Keep top-K facts after reranking
  detect_contradictions: true      # Find disagreements between facts
  detect_drift: true               # Check for topic wandering
  confidence_from_agreement: true  # Calculate confidence from fact consensus
  min_facts_for_rerank: 3          # Only rerank if this many facts exist

# ==============================================================================
# Cognitive Cycle Execute Phase Configuration
# Restores the old orchestrator's auto-wire enforcement — config-driven, no hardcoding.
# ==============================================================================

kernel_cell_execute:
  # Minimum tool calls required before synthesis/complete is allowed. 0 = no enforcement.
  min_tool_calls_before_synthesis: 1

  # Step index after which a "use your tools" nudge fires when tool_call_count is 0.
  tool_call_nudge_after_step: 1

  # Downgrade quality to "poor" if tools were available but tool_call_count < min.
  # Prevents 91% confidence with 0 tool calls.
  tool_call_quality_penalty_enabled: true

  # Fallback when RAG returns 0 tools (cold start / empty registry): use GET /tools.
  # 0 = disabled.
  rag_fallback_static_limit: 10
